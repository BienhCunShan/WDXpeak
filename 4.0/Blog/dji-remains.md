# DJI 零碎笔记

# 工作日志

## 参与的项目

这里是在 DJI 我参加的项目及所扮演的角色

1. UTM - 无人机飞行管理系统，和美国团队合作。
    + 角色：产品经理、项目经理、架构设计、系统搭建、技术选型、核心功能开发
    + QPS 指标
    + 算法研究，和 NASA/Google/Amazon 竞争
    + 基于真实飞行数据的模拟器开发
    + 全球部署
2. 日志平台 - 基础架构搭建与数据导入工作。
    + 角色：架构设计、部署维护、核心功能开发
    + 日志统一管理，极大提高了开发测试查错效率
    + 作为数据平台的底层提供架构支持
    + 方便水平拓展、容错
    + 技术栈：Kafka, Elasticsearch, Logstash, Kibana
3. 数据平台 - 基础架构搭建与接口开发工作。接入激活和出厂数据，为数据展示前端进行接口开发
    + 角色：架构设计、部署维护、核心功能开发
    + 基本的商业智能平台，为市场营销提供数据支持和决策建议
    + 通用+高自定义的平台，能够满足各个业务线的需求
    + 数据清洗流水线，方便从不同数据源接入数据
    + 支持权限控制，报表生成
    + 技术栈：Spring, ELK, Spark/Hadoop
4. 国内监管项目 - 无人机监控系统后台（禁飞区、信息认证等）
    + 角色：功能开发
5. 欧洲研究项目申请
    + 角色：技术支持、沟通协调
    + 文档阅读研究
6. 用户中心后台 - 视频社区天空之城的单点登录开发
    + 角色：功能开发
    + 单点登录、跨国数据同步
7. 内部 OPM 系统开发，构建创新的绩效评估体系，模仿股票交易市场
    + 架构、财务、人事等各个系统信息接入

## 数据平台周报

16.9.27 之一句话 highlight

设计新的架构以支持更多服务，对接各个部门需求完成数据展示页面，日志、数据上报流程规范化。

## 月报归档

这里是周报及相关文档归档。

## 2016.12 考核

**员工总结**

本月我的主要工作有

1. 股价系统顺利接入工时、财务、模块、项目阶段等数据
2. 股价系统完成核心计算引擎的开发，股价、项目分配、模块分配、人员分配均与 Adair 使用 Excel 计算的数据对上
3. 股价系统进入产品打磨阶段，进行前端展示、逻辑优化和用户体验提升（这部分需要一定时间，但系统本身已经可用）
4. 为股价系统之后要增加的交易功能进行技术测试与预研
5. 为研发后台系统设计更安全、合理的架构方案，在此过程中进行技术积累，节约开发资源

附：17 年粗略计划

1. 深入了解研发业务，在此基础上做好一整套项目管理及研发支持的系统，利用各类数据优化项目开展（如：通过工时数据优化人员分配、通过飞行数据为研发各个模块提供数据支持等等），保证各个项目的顺利展开（尽量让大家专注于工作而不是流程，能自动化的就自动化）
2. 为研发后台搭建好更加现代化的软件工程架构，用『小步快跑』的方式进行系统的迭代，减轻开发人员负担，提高效率
3. 组建一个有战斗力的小团队，并在开发过程中进行技术积累，力争在软件工程上也做出自己的特色，在提高团队技术水平的同时，也能吸引更高水平的人才，进入良性循环

**自我评价**

基本已经适应新的工作内容，也逐渐开始有了自己的思考和想法，非常感谢大家的支持、配合和信任。这个月基本完善了股价系统（还有部分零散的需求需要在使用中不断迭代），也在不断的数据核对中巩固了专业、专注的工作态度。

与此同时，也发现了研发的后台系统中仍旧有很多需要提高和完善的地方，这里值得今后多下功夫，争取针对不同的问题找到最合适的解决方案。


### 2016.10 考核

**员工总结**

1. UTM 项目后台开发完成，转为跟随美国 NASA 的进度进行跟进开发。
2. 参与 Global UTM 的研讨，加入 GUTMA 的架构工作组，参与 Global UTM 的架构设计讨论，帮助公司了解最近新情况，施加影响（往我们已有专利的方向上引导）
3. 与知识产权部门合作，参与欧洲 UTM 研究的投标，可能以 Advisor 的身份参与并了解欧洲 UTM 的相关进展。
4. 数据平台项目完成了销售部的数据需求，保证日志收集服务的稳定，之后会继续进行流程的规范和效率的提高。
5. 下旬被 Mingyu 抽调去 22 楼负责研发内系统的开发及已有系统的整合，目前新系统已经基本开发完毕，需求调整、外部系统接入以及架构梳理和部署的阶段。

虽然工作内容有不小的变动，但是自己能够很快适应并以较高的效率完成系统的设计和开发。经过一段时间的熟悉，对于比较多而杂的事情也基本能够做到分清主次，按照优先级依次完成。最近在自上而下推动的公司资源整合是一个很好的事情，会努力尽一份力，用技术提高运转效率。

### 转正自评

试用期中我主要参与的项目是（简历中也可以参考）

1. 和美国团队 Walter 合作的 UTM 项目。和 Walter 讨论确定基本需求，排期完成系统搭建；Andrew 进行技术讨论，根据需求选择合适的技术，并进行基本的技术可行性测试
    + 角色：产品经理、项目经理、架构设计、系统搭建、技术选型、核心功能开发
    + QPS 指标
    + 算法研究，和 NASA/Google/Amazon 竞争
    + 基于真实飞行数据的模拟器开发
    + 全球部署
2. 日志平台的基础架构搭建与数据导入工作。接入 djiservice, sdk, flysafe 和 sky pixel 的日志，完成搭建基于 Kafka 的日志处理队列系统
    + 角色：架构设计、部署维护、核心功能开发
    + 日志统一管理，极大提高了开发测试查错效率
    + 作为数据平台的底层提供架构支持
    + 方便水平拓展、容错
    + 技术栈：Kafka, Elasticsearch, Logstash, Kibana
3. 数据平台的基础架构搭建与接口开发工作。接入激活和出厂数据，为数据展示前端进行接口开发
    + 角色：架构设计、部署维护、核心功能开发
    + 基本的商业智能平台，为市场营销提供数据支持和决策建议
    + 通用+高自定义的平台，能够满足各个业务线的需求
    + 数据清洗流水线，方便从不同数据源接入数据
    + 支持权限控制，报表生成
    + 技术栈：Spring, Elasticsearch, Kibana, Spark/Hadoop
4. 国内监管项目的后台开发工作。代码重构及功能开发
    + 角色：功能开发
5. 参与欧洲研究项目的申请工作。文档阅读与联系协调
    + 角色：技术支持、沟通协调

通过参与各个项目，逐步了解了公司内部的组织架构和合作方式，慢慢能够独当一面。


## 了解的项目

这里是我了解，开过会但没有具体参与的项目

### PC 地面站

数据上报



### Mobile SDK（160720）

今天和 Roy 开会，他是原来在苹果负责 iPhone 4s 天线开发，后来挖过来的大牛。在大疆他主要负责 Mobile SDK 部分的开发。

今天和他开会主要是聊了一下他们下一步想要做的事情，主要是一个资产管理的服务。目前的 SDK 已经可以收集关于飞行器、电池等本身的相关数据并上传到服务器中。

如果一个公司有几十架无人机，那么管理这些无人机和管理更多的电池（一般来说一台无人机会配备多个电池）就是一个巨大的挑战。有大量无人机的公司一般都会用自己开发的基于 Mobile SDK 的应用来进行飞行，我们可以提供服务，帮助他们管理资产，比方说电池电量、遥控器和飞机固件版本等等信息。电子到实物的对应可以用贴纸等标签来作为最简单的追踪方式。企业用户只需要在我们的系统中注册对应设备（通过 mobile sdk），就可以在 web 界面中进行管理。

### 如故

运营文章：读书无疑

思路：

+ 借用朱子的经典语录引申为读书不要犹豫
+ 论点：想成为什么样的人，就去读什么样的书
+ 论据：结合各种方向对应书，引起兴趣
+ 提升：把书和朋友联系起来，好朋友，就是好书
+ 广告时间：如故的特色，为什么能帮助用户找到合口味的朋友

朱子曾经曰过『读书无疑者，须教有疑，有疑者却要无疑，到这里方是长进』。中华文化博大精深在于，这里的『疑』，可以看做『疑惑』，也可以看做『犹疑』。如果是看做后者，那么读书当然应该『无疑』。读书这么好的事情，不需要犹疑！

想成为什么样的人，就去读什么样的书。

生活若是精致：可以夫物芸芸，各复归其根，念念追忆，《惜别》在远道；抑或如《简单的艺术》般禅意地栖居。

生活若是实际：可以手持《穷查理宝典》，做出更好的投资和决策；抑或从《拖延心理学》中看清我们对失败成功控制疏远和依附的恐惧。

想成为世界的守护者，可以像《神们自己》的左情者那样独自面对愚昧；抑或从《后望书》中看看我们远去的历史风景；

想龙潭虎穴独闯，可以做一个《优秀的叛逆者》，去做事儿而不是制造麻烦；抑或毅然《亮剑》，即使倒下也要称为一座山一道岭。

有天下大同梦，可以在《我们最幸福》中看见熟悉而又陌生的国度；抑或从《曾国藩家书》里揣摩治军为政之道，畅想人生处世之谈。

只想修身齐家，可以如《生命最后的读书会》般开始一段阅读广度和人生深度的对话之旅；抑或感受自己《禅者的初心》，随时准备好去接受、怀疑，然后在一闪念中证悟到万物的原初本性。

精神主导的自我，可以在《风沙星辰》下，与心爱之人共同展望一个方向；抑或做一个超凡脱俗的《小王子》，告别小行星，开始遨游太空的旅行。

感官主导的自我，可以重温《十八岁给我一个姑娘》的躁动与迷恋；抑或走进《失乐园》看看国外的都市生活和种种心态。

想成为什么样的人，就去读什么样的书，就去交什么样的朋友。好书如良师益友，而每个人都是一本书。用『如故』，寻知己，恰似读书。

+ 匹配算法：科学的不科学，缘分本随机，科学更可取
+ 内心世界：不透明的透明，三观本无形，无招胜有招
+ 挑剔择友：意外的不意外，品质本天成，欲辨已忘言
+ 优质群体：不特别的特别，菩提本无树，水涨船亦高

<- 此处可放下载地址

# 人事相关

## 人员角色

+ Minyu.Wang：研发 VP，原来做相机相关的
+ Fiona.Liu：Minyu 的秘书，大小事情基本上先跟她通报，周报也需要抄送她
+ Hank.Shao：火哥，公共关系，和政府部门相关的工作
+ Shaojie.Shen：研发那边的博士
+ Brendan.Schulman：海外政策老大
+ Christian.Struwe：负责欧洲那边的政策相关
+ Michael.Perry：公关政策方面
+ Orion.Yang：软件部产品负责人
+ Cheng.Ouyang：研发部门
+ Xiaodan.Wang：知识产权部门
+ Walter.Stockwell：美国 UTM 政策相关
+ Andrew.Price：美国团队的开发
+ Bene.Gao：IT 部门老大
+ Ge.Bai：IT 部门二级领导
+ Eva.Lan：IT 部门物流系统负责人
+ Archer.Wang：IT 部门负责数据对接工程师
+ Landy.Zhou：市场部产品经理
+ Ricco.Teng：滕芬，销售部拉美区的对接人
+ Ben.Guo: benkwok 地面站的PM郭灼
+ Wit.Xie: PC地面站的产品，老大是 ben.guo
+ Wiki.Wu: 软件部的 PM
+ Nathan.Yan: 软件部的安卓开发
+ Shaun.Yi: 易肖鸿，现在在负责 Skypixel
+ Allen.Zheng: 负责北美销售
+ Min.Gong: 龚敏 HR

# 总体开发相关

## 内部帐号

+ DJI 内部帐号: 
+ Portal, Conluence, Outlook: da.wang key:newEGO1130  
+ GT da.wang newEGO615
+ QQ 登录是用 da.wang@dji.com 
+ 数据平台: da.wang newEGO615
+ 推广联盟: da.wang@dji.com newEGO615

邮箱客户端登录

+ server: mail.djicorp.com
+ 域: dji.com
+ 邮箱: da.wang@dji.com

## 编号

+ 中国监管: SW511 + BR1603 -> BR1607
+ UTM: BR1604
+ Skypixel: SW514

## 开发相关技术

+ 语言：Go, Java, Python, Shell
+ 数据库：MySQL, Redis
+ 服务器：Nginx
+ 数据平台：Elasticsearch, Logstash, Kibana
+ 消息队列：Kafka
+ 服务管理：Zookeeper

## 跳板机

可以使用 `ssh-copy-id` 和 `expect` （都需要自行安装）配合写脚本进行自动登录跳转并切换用户。

```bash
# 跳板机帐号
ssh dawang@47.89.28.87 -p8888

dawang
B!7FOAu%lVs18r+Q2)xAj

# 安装
brew install homebrew/dupes/expect
brew install ssh-copy-id
# ubuntu : sudo apt install expect
# 这样登录一次就把密钥拷过去了，以后就不用两步验证了
# https://github.com/jiangxianli/SSHAutoLogin
ssh-copy-id dawang@47.89.28.87 -p8888
```

自动登录脚本（以 djiservice 为例）

```bash
#!/usr/bin/expect -f

set timeout 2
set passwd "qrZDIyJmrYo"
set hostname "jumpserver"
spawn $env(SHELL)
match_max 100000
send -- "ssh -p 8888 dawang@47.89.28.87\r"
expect "$hostname"
send -- "su - service\r"
expect "Password:"
send -- "$passwd\r"
expect "$hostname"
send -- "cd project/dji-service/\r"
expect "$hostname"
interact
```

# 长邮件收集

## 数据平台技术路线及规范

Hi All,

在数据平台架构及配套服务的初步搭建完成后，经过一段时间的试运行，随着接入数据平台的业务和数据量的增加，还是暴露了一些问题。考虑到国庆节后会有更多的业务及数据接入进来，我和磊哥以及数据平台核心开发小组的成员讨论后，梳理了数据平台未来的演进方向。

PS: 请各位产品经理转给对接数据平台以及数据上报相关的开发人员（不一定都在收件人中）

**现状及主要问题及对应方案**

目前数据平台主要提供三大类别的服务：

1. 日志收集
2. 打点上报数据收集
3. 综合不同数据源的统计与分析

试运行时主要暴露的问题有：

1. 服务器错误日志带有非法字符，导致 es 无法正确解析
2. 服务器日志有同名但是类型不同的字段，导致 es 的索引冲突
3. 埋点数据上报数据有同名但是类型不同的字段，导致 es 的索引冲突
4. 因为 es 的索引机制，未提前指定的字段会被分词，导致统计时候处理困难
5. 新业务接入是流程不太合理，需要太多手动操作的步骤

解决方案：

1. 限制最长的日志长度，过滤错误和超长日志
2. 服务器日志分接口处理，添加前缀解决冲突
3. 协调和规范数据上报格式，尽量统一，或者添加前缀解决冲突
4. 提前告知数据上报的字段及类型，指定不需要分词的字段
5. 完善接入流程，尽量自动化

**关于之前 es 服务质量骤降原因的排查及优化**

一句话总结：多重原因综合作用下导致集群进入了不可自动恢复的死循环，导致大部分时间和性能都浪费在了反复的重复操作。经过排查已经找到了原因，解除了死锁之后增加了各个环境的稳定性。

具体的原因有：

+ 随着业务接入量的增加，刚好达到了某个触发 jvm 垃圾回收的阈值
+ es 集群的 jvm 堆大小过小，导致年轻代一直触发阈值，经常需要垃圾回收，而且使得年老代的空间迅速被占满
+ 年老代进行垃圾回收的时候会暂停所有工作，集群主节点在几次尝试连接失败后认为集群拓扑变化，为了保证高可用开始进行数据转移
+ 在年老代垃圾回收完成后，集群的状态会再次改变（主节点此时又可以找到刚才因为垃圾回收而无响应的节点），于是又开始进行数据转移
+ 数据转移的过程又会触发垃圾回收，于是进入了死循环，服务质量就迅速降低

解决方法：

+ 依据官方指引增加 jvm 堆大小，尽量减少垃圾回收的次数
+ 增大集群检测拓扑变化的时间，留足够的时间给正在进行年老代垃圾回收的机器
+ 优化索引的分片及副本数目，提高查询速度

总结

还是希望大家善待数据，善待数据平台，想要查询的时候方便快捷，存的时候就需要精心设计，NoSQL 并不是银弹，深入思考和精心设计才是，这样就可以避免出现很多疑难杂症。

## 数据平台现状与未来计划

Hi All，

下面是数据平台的现状及未来计划。

在数据平台架构及配套服务的初步搭建完成后，经过一段时间的试运行，随着接入数据平台的业务和数据量的增加，还是暴露了一些问题。考虑到国庆节后会有更多的业务及数据接入进来，我和磊哥以及数据平台核心开发小组的成员讨论后，梳理了数据平台未来的演进方向。

为了让大家更清晰地了解我们的整体思路，方便以后对接与合作，在这里简单介绍一下数据平台的现状和之后的计划。如果大家有什么意见和建议，请尽管提出来，希望能够群策群力把数据平台做得更好，给大家提供更多的便利。

**核心思路**

作为公司平台化和数据化的一环，我们对数据平台的期望是提供对运营、产品、市场和决策的数据及分析支持。融合与汇总来自不同系统的数据，以数据为基础，应用为核心，达到公司运作的『数据自洽』状态，最终转化为更优秀的产品和更优秀的用户体验。

在深入了解各个部门的业务实践及需求后，具体分为两步走：

1. 取代。这里指的是利用数据平台完成原来需要用 Excel 及人工收集的各项信息，做到自动化及半实时。
2. 超越。这里指的是利用数据平台完成原来无法实现或需要大量人力的分析，如结合不同系统的数据挖掘出有用信息，给出直观且美观的报表。

**现状及主要问题**

目前数据平台主要提供三大类别的服务：

1. 日志收集
2. 打点上报数据收集
3. 综合不同数据源的统计与分析

试运行是主要暴露的问题有：

1. 打点上报数据字段不规范。主要表现是打点数据的设置过于随意，不同平台常常出现同名但是类型不同的字段，轻则导致数据插入无效，重则会影响服务的效率。
2. 数据平台的硬件资源限制。计算能力，存储容量和带宽以及跨海访问延迟有时候会导致服务质量降低。
3. 运维难度较大，没有一套完整的监控系统。
4. 人力不足，因为部门对接以及需求的多样化，目前的核心开发人员捉襟见肘。

**未来计划**

针对前面的提到的各个问题以及数据平台的可持续发展，未来计划如下：

1. 打点数据命名规范及类型检查。用更严格的检查来保证数据的纯净度。
2. 国内及国外各部署一套基础服务设施，用来就近提供服务，利用云存储绕开跨海服务延迟这个大问题。在可能的情况下扩充数据库集群机器数量。
3. 在各个环节都需要有简单的图形化管理及监控系统，尽量减少需要登录到机器上进行手动敲命令运维的次数。
4. 拥有更多固定的开发人员，进行比较稳定的需求排期及功能迭代开发

**总结**

总体来说，虽然前段时间因为数据量增长而导致了比较严重的服务质量下降，但是经过两天的调整，数据平台目前已经重新稳定了下来。正所谓塞翁失马焉知非福，能借此机会完善和优化数据平台的技术与相关流程规范，让它发挥更大的作用，也是不错的事情。

在这里先谢谢大家一直以来的理解和支持。希望之后能继续一起把数据平台做得更好


